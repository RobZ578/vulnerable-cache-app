events {}

http {
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m inactive=60s;

    server {
        listen 80;

        location / {
            proxy_pass http://flask-app:5000;
            proxy_cache my_cache;
            proxy_cache_valid 200 1h;

            # STRENGTHENED VULNERABILITY: 
            # The cache key ONLY uses the URL. 
            # It ignores Host, Encodings, and User-Agents.
            proxy_cache_key "$request_uri";

            # Pass the poison header to Flask
            proxy_set_header X-Forwarded-Host $http_x_forwarded_host;
            
            add_header X-Cache-Status $upstream_cache_status;
        }
    }
}